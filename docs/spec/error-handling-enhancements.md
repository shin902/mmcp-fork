# エラーハンドリングとユーザー通知改善 設計メモ

## 背景
- 現状の `mmcp` は CLI 実行中の失敗理由が標準エラーで平文として表示されるのみで、発生箇所や復旧手順の情報が乏しい。
- ユーザーからは「何が原因で失敗したのか」「どの設定を見直すべきか」が分かりづらいとの声がある。
- エラー分類・通知の改善、および失敗時に次のアクションへ導くヒントの表示を行うことで CLI の使いやすさを高めたい。

## 目的
1. 重大度や性質が異なるエラーを分類し、ユーザーが即座に状況を把握できるようにする。
2. CLI の出力から復旧手順を導き出せるよう、エラー内容と推奨アクションを併記する。
3. 設定ミス・外部サービス障害・内部不具合を切り分けやすくし、サポートや Issue 作成の手がかりを提供する。
4. 今後の機能追加でも一貫したエラーハンドリングを行える共通レイヤーを整備する。

## スコープ
- CLI コマンド (`mmcp add/remove/apply/list/agents`) における同期的な失敗ケース。
- 設定ファイル (`~/.mmcp.json` 等) の読み書き時に発生する例外。
- エージェントアダプタ (`src/lib/agents/*`) が返す外部サービス連携エラー。
- CLI のユーザー向け標準出力・標準エラーの表現。

## 非スコープ
- HTTP リトライや指数バックオフなどの通信耐障害化（必要に応じて別タスクで検討）。
- GUI や別インターフェースの追加。
- エラーログの永続化や集中管理（ログ出力を JSON 化する程度まで）。

## ユーザー課題と改善方針
| 課題 | 影響 | 改善案 |
| --- | --- | --- |
| エラー文が抽象的 | 復旧に時間がかかる | エラー種別 + 具体的な原因 + 推奨アクションを定型で表示 |
| 設定ファイル破損時に原因不明 | 再初期化手順が分からない | バリデーションエラー詳細と `mmcp` の再初期化ガイドを提示 |
| エージェント毎にエラーメッセージがバラバラ | サポートへの共有が難しい | エラーコードと内部ログ向け詳細メッセージを分離 |
| 再現報告が難しい | Issue 作成の手間 | 再現情報テンプレートと `mmcp --diagnose`（別タスク）の案内 |

## 実装全体像
1. **エラー型の整理**
   - 共通の `CliError`（`type` + `message` + `hint` + `metadata`）を `src/lib/errors.ts` に新設。
   - 既存コードで `throw new Error()` を直接使っている箇所を `CliError` へ差し替え。
   - 重大度（`fatal`/`recoverable`/`warning`）を `severity` として保持。
2. **表現レイヤーの統一**
   - `src/lib/logger.ts`（新設）で標準エラー出力の整形処理を集中化。
   - カラー出力（`chalk` など既存依存を利用）とアイコンでエラー種類を可視化。
   - CLI からは `handleCliError(error)` を呼び、内部でログと終了コードを制御。
3. **ケース別の丁寧なメッセージ**
   - 設定ファイル: JSON パース失敗時にファイルパス・該当キー・修復手順（バックアップ作成→再初期化）を提示。
   - エージェント認証: 必須環境変数が不足している場合に不足項目一覧と設定例を表示。
   - ネットワーク: タイムアウトや DNS 失敗を検出し、再試行の目安・サポート連絡方法を案内。
4. **拡張しやすい仕組み**
   - `CliError` に `code` を設け、`AGENT_CONFIG_MISSING` など識別子で管理。
   - 新規コマンド追加時はコードとヒントを登録するだけでガイド付きエラーが得られる構造。
5. **診断情報の提供**
   - `--verbose` オプションで内部スタックトレースや `metadata` を JSON で出力するモードを追加。
   - Issue への貼り付け用テンプレート（再現手順・バージョン情報・`metadata`）を表示。

## 作業タスク
1. 事前調査
   - エラーを投げている既存箇所を洗い出し、分類（I/O、設定、エージェント、未知）する。
   - コマンド毎に想定される失敗パターンを記載したチェックリストを作成。
2. コア実装
   - `CliError` 型と生成ヘルパー関数（`createConfigError`, `createAgentError` 等）を追加。
   - `handleCliError` を CLI エントリポイントに組み込み、未捕捉例外を共通ハンドラに集約。
   - 各コマンド/ライブラリで固有情報（対象ファイル、エージェント名など）を `metadata` に格納。
3. メッセージ整備
   - 主要な 10 ケース（例: 設定ファイルなし、JSON 破損、認証情報不足、ネットワークタイムアウトなど）について、ユーザー向け文面とヒントを日本語で策定。
   - 自動テストでメッセージが変更された場合に検知できるようスナップショットやマッチャーを整備。
4. CLI オプション追加
   - `--verbose` 時は `CliError` を JSON 形式で出力し、スタックトレースを付加。
   - `--no-color` 時の表示崩れを防ぐためのフォールバックを用意。
5. テスト
   - 各エラーケースで適切なコードとヒントが出力されるかを `bun test` でカバー。
   - E2E 相当として `scripts/fixtures` に失敗シナリオを用意し、スナップショットテストを追加。
6. ドキュメント
   - `README` に「失敗時の対処」の章を追加し、よくある質問と `--verbose` の使い方を記載。
   - CHANGELOG へエラーハンドリング改善の項目を追加（リリース時）。

## リスクと対応策
- **既存テストの崩壊**: エラーメッセージ変更に伴いスナップショットが大量に壊れる可能性 → 段階的なメッセージ調整と `expect.stringContaining` の利用で影響を局所化。
- **依存追加コスト**: カラー出力ライブラリが増える場合はバイナリサイズや互換性を再確認。
- **予期せぬ未捕捉例外**: 共通ハンドラでの包摂により、今まで露出していたスタックが見えなくなる → `--verbose` を既定で案内し、Issue にスタックを添付できるようにする。

## 今後の拡張アイデア
- `mmcp diagnose` コマンドを追加して、環境チェック結果をまとめて表示する。
- 失敗履歴を `~/.mmcp/logs` に JSON で保存し、過去の実行状況を確認できるようにする。
- エラーコードをドキュメント化し、ユーザーが検索しやすいナレッジベースを用意する。

## 技術要件詳細

### 必要な依存関係
- `chalk`: v5.6.2（既存）- カラー出力
- `ora`: v8.2.0（既存）- プログレスインジケーター  
- 新規依存なし（既存ライブラリで実現）

### TypeScript型定義
```typescript
// src/lib/errors.ts
export type CliErrorCode = 
  | 'CONFIG_FILE_NOT_FOUND'
  | 'CONFIG_PARSE_ERROR'
  | 'AGENT_NOT_SUPPORTED'
  | 'AGENT_CONFIG_MISSING'
  | 'NETWORK_TIMEOUT'
  | 'FILE_PERMISSION_DENIED';

export type CliErrorSeverity = 'fatal' | 'recoverable' | 'warning';

export interface CliErrorMetadata {
  filePath?: string;
  agentId?: string;
  serverName?: string;
  [key: string]: unknown;
}

export class CliError extends Error {
  constructor(
    public code: CliErrorCode,
    public severity: CliErrorSeverity,
    message: string,
    public hint?: string,
    public metadata?: CliErrorMetadata
  ) {
    super(message);
  }
}
```

## エラーコード体系

| カテゴリ | コード | 重大度 | 例 |
|---------|--------|--------|-----|
| 設定 | CONFIG_FILE_NOT_FOUND | recoverable | 設定ファイルが見つからない |
| 設定 | CONFIG_PARSE_ERROR | recoverable | JSON解析エラー |
| エージェント | AGENT_NOT_SUPPORTED | fatal | 未対応エージェント |
| エージェント | AGENT_CONFIG_MISSING | recoverable | エージェント設定不足 |
| ネットワーク | NETWORK_TIMEOUT | recoverable | 接続タイムアウト |
| 権限 | FILE_PERMISSION_DENIED | fatal | ファイル書き込み権限なし |

## テスト更新戦略

### 既存テスト影響調査
- 現在確認済み: `apply.spec.ts`で7つの`.toThrowError()`テスト
- **要調査**: 全`.spec.ts`ファイルでの文字列マッチテスト総数
- **要調査**: スナップショットテスト有無の確認
- **要調査**: E2Eテストでのエラー出力依存箇所

### 移行アプローチ
1. **Phase 1**: 新しいエラー型を追加（既存テスト破綻なし）
2. **Phase 2**: 既存エラーを段階的に移行
3. **Phase 3**: テストを`expect.stringContaining()`に更新

### テスト移行例
```typescript
// 変更前
expect(() => action()).toThrowError("Unsupported agents: foo, bar.");

// 変更後
expect(() => action()).toThrow(
  expect.objectContaining({
    code: 'AGENT_NOT_SUPPORTED',
    severity: 'fatal'
  })
);
```

## 国際化対応方針

### 当面の実装（v1.0）
- 日本語メッセージで実装（CLAUDE.md要件に準拠）
- エラーコードは英語（技術的識別子）

### 将来拡張（v2.0以降）
- 環境変数`LANG`による言語切り替え
- メッセージテンプレート外部化
- `--locale`オプション追加

## パフォーマンス要件

### 許容範囲
- CLI起動時間増加: +50ms以内
- エラー発生時の追加処理時間: +100ms以内
- メモリ使用量増加: +5MB以内

### 最適化戦略
- 診断情報は遅延評価（`--verbose`時のみ）
- エラーメッセージテンプレートの事前コンパイル
- 不要な依存関係読み込みの回避

## 詳細実装スケジュール

### Milestone 1: コア基盤（Week 1-2）
- [ ] `CliError`型定義 (`src/lib/errors.ts`)
- [ ] `handleCliError`実装 (`src/lib/logger.ts`) 
- [ ] `--verbose`オプション追加
- [ ] 基本的なカラー出力

### Milestone 2: エラー移行（Week 3-4）
- [ ] 設定関連エラーの移行（3箇所）
- [ ] エージェント関連エラーの移行（8箇所）
- [ ] その他エラーの移行（5箇所）

### Milestone 3: 品質向上（Week 5）
- [ ] 日本語メッセージ整備
- [ ] 診断情報収集機能
- [ ] テスト更新とドキュメント

## 具体的なリスク対応

### 既存テスト破綻への対策
1. **影響調査**: 全テストファイルスキャンスクリプト作成
2. **段階的移行**: 新旧エラー形式の並行運用期間設定
3. **自動化**: エラーメッセージ変更検出CIチェック追加

### 後方互換性維持
1. **レガシーモード**: `--legacy-format`フラグ実装
2. **バージョニング**: セマンティックバージョニング厳守
3. **移行期間**: 2バージョンの並行サポート

### 技術的不確実性への対応
1. **エージェントアダプター調査**: 各アダプター固有エラーパターンの詳細分析
2. **パフォーマンス検証**: 実装初期段階でのベンチマーク測定
3. **ユーザビリティテスト**: エラーメッセージの分かりやすさ検証

## 成功指標と検証方法

### ユーザビリティ指標
- エラー解決時間: 30%短縮目標
- サポート問い合わせ件数: 40%削減目標
- Issue作成時の情報充足率: 80%以上

### 技術指標  
- テストカバレッジ: 90%以上維持
- CI/CD実行時間: +10%以内の増加
- バンドルサイズ: +5%以内の増加

### 検証方法
- ユーザーアンケート実施
- サポートログ分析
- パフォーマンステスト自動化

## 実現可能性評価

### 総合評価: 85%（高い実現可能性）

**100%でない15%のリスク要因:**
- **技術的不確実性（8%）**: 既存テスト影響範囲とエージェント固有エラーパターンの詳細が未調査
- **運用・保守性リスク（4%）**: 国際化要件の複雑性とメンテナンス負荷増加
- **調査不足領域（3%）**: パフォーマンス影響とユーザビリティの実証データ不足

**軽減策:** 実装初期段階での詳細調査により、これらのリスクは技術的に解決可能

## Issue 用サマリ（ドラフト）
```
### 概要
mmcp のエラーハンドリングを刷新し、CLI で発生した失敗について「原因・影響・推奨アクション」が一目で分かるようにする。

### やりたいこと
- 共通エラー型 `CliError` の導入とコード体系化
- CLI の出力フォーマット統一（重大度・アイコン・ヒント表示）
- 代表的な失敗ケースに対する丁寧なメッセージ整備
- `--verbose` モードでの詳細出力と Issue テンプレート案内

### 成果物
- エラーハンドリング改善の実装
- 新規テストケースとドキュメント更新

### 補足
Issue 作成時は `docs/spec/error-handling-enhancements.md` を参照してください。
```
